<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ù—É–º—ñ–∑–º–∞—Ç Pro: Global Update</title>
    <style>
        :root { --gold: #f1c40f; --blue: #3498db; --ios-bottom: calc(45px + env(safe-area-inset-bottom, 20px)); }
        body { margin: 0; height: 100svh; overflow: hidden; background: #000; font-family: -apple-system, system-ui, sans-serif; color: white; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
        #container3d { position: absolute; top: 0; left: 0; width: 100%; height: 50svh; z-index: 1; }
        #ui-layer { display: none; position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        #ui-layer button, #modal, .window { pointer-events: auto; }
        
        #top-bar { position: absolute; top: calc(10px + env(safe-area-inset-top, 20px)); left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-group { display: flex; flex-direction: column; gap: 4px; position: relative; }
        .stat { background: rgba(30,30,30,0.85); padding: 6px 10px; border-radius: 10px; border: 1px solid var(--gold); font-size: 13px; font-weight: bold; text-align: center; min-width: 80px; display: flex; align-items: center; justify-content: center; gap: 4px; }
        
        #passive-notice { position: absolute; right: -45px; top: 10px; color: #2ecc71; font-weight: bold; opacity: 0; transition: 1s; pointer-events: none; }
        .mode-indicator { font-size: 9px; color: var(--gold); margin-top: 2px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-top-red { background: #c0392b; color: white; border: none; padding: 6px 12px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-top: 5px; cursor: pointer; }

        #modal { display: none; position: absolute; bottom: calc(100px + var(--ios-bottom)); left: 50%; transform: translateX(-50%); background: rgba(15,15,15,0.98); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--gold); width: 85%; max-width: 280px; z-index: 100; }
        .main-nav { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 10px 15px var(--ios-bottom) 15px; background: linear-gradient(transparent, rgba(0,0,0,1) 70%); }
        .nav-btn { flex: 1; padding: 12px 5px; border-radius: 12px; border: none; font-weight: bold; font-size: 10px; cursor: pointer; text-transform: uppercase; }
        .btn-blue { background: #3498db; color: white; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn-orange { background: #e67e22; color: white; }

        .window { display: none; position: fixed; inset: 0; background: #111; z-index: 5000; padding: calc(20px + env(safe-area-inset-top)) 20px; flex-direction: column; }
        .list-container { flex: 1; overflow-y: auto; margin-top: 15px; padding-bottom: 40px; }
        .list-row { background: #1a1a1a; margin-bottom: 8px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; border: 1px solid #333; align-items: center; gap: 10px;}
        
        .mode-tabs { display: flex; gap: 5px; background: #222; padding: 5px; border-radius: 10px; margin-top: 10px; }
        .tab-btn { flex: 1; padding: 8px; border: none; border-radius: 7px; background: transparent; color: #888; font-size: 10px; font-weight: bold; }
        .tab-btn.active { background: var(--gold); color: #000; }

        #menu { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-btn { width: 80%; padding: 18px; margin: 8px; border-radius: 15px; border: 2px solid var(--gold); background: #111; color: white; font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="color:var(--gold); letter-spacing: 2px;">–ù–£–ú–Ü–ó–ú–ê–¢</h1>
    <p id="player-display" style="font-size: 13px; color: #aaa; margin-bottom: 20px;"></p>
    <button class="menu-btn" onclick="startGame('easy')">–ü—Ä–æ—Å—Ç–∏–π</button>
    <button class="menu-btn" onclick="startGame('medium')">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
    <button class="menu-btn" onclick="startGame('realism')">–†–µ–∞–ª—ñ–∑–º</button>
    <button class="menu-btn" style="border-color:#3498db; margin-top: 15px;" onclick="openAuction()">üèõÔ∏è –ê–£–ö–¶–Ü–û–ù</button>
    <button class="menu-btn" style="border-color:#555; font-size: 14px;" onclick="openRank()">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
</div>

<div id="ui-layer">
    <div id="top-bar">
        <div class="stat-group">
            <div class="stat">
                ‚Ç¥ <span id="money-val">0</span>
                <span id="passive-in-balance" style="color:#2ecc71; font-size: 10px; margin-left: 2px;">(+‚Ç¥0)</span>
            </div>
            <span id="passive-notice">+‚Ç¥0</span>
            <div class="stat">XP <span id="xp-val" style="color:var(--blue)">0</span></div>
            <center id="current-mode-label" class="mode-indicator"></center>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end;">
            <button class="stat" style="background:#444; border:none; color:white; cursor:pointer;" onclick="location.reload()">–ú–ï–ù–Æ</button>
            <button class="btn-top-red" onclick="resetGame()">–ó–ê–ù–û–í–û</button>
        </div>
    </div>

    <div id="modal">
        <h3 id="m-title" style="margin:0; color:var(--gold);"></h3>
        <div id="coin-desc" style="margin:10px 0; font-size:14px;"></div>
        <div style="display:flex; gap:8px;">
            <button class="nav-btn btn-blue" onclick="keepFound()">–í –ê–ª—å–±–æ–º</button>
            <button class="nav-btn" style="background:#444; color:white;" onclick="sellFound()">–ü—Ä–æ–¥–∞—Ç–∏</button>
        </div>
    </div>

    <nav class="main-nav">
        <button id="work-btn" class="nav-btn btn-blue" onclick="work()"></button>
        <button id="search-btn" class="nav-btn btn-gold" onclick="search()"></button>
        <button class="nav-btn btn-purple" onclick="toggleAlbum()">–ê–ª—å–±–æ–º</button>
    </nav>
</div>

<div id="auc-win" class="window">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h2>üèõÔ∏è –ê—É–∫—Ü—ñ–æ–Ω</h2><button onclick="closeAuc()" style="background:none;border:none;color:red;font-size:40px;">&times;</button></div>
    <div class="mode-tabs">
        <button id="tab-auc-easy" class="tab-btn" onclick="refreshAuc('easy')">–ü—Ä–æ—Å—Ç–∏–π</button>
        <button id="tab-auc-medium" class="tab-btn" onclick="refreshAuc('medium')">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
        <button id="tab-auc-realism" class="tab-btn" onclick="refreshAuc('realism')">–†–µ–∞–ª—ñ–∑–º</button>
    </div>
    <div id="auc-list" class="list-container"></div>
</div>

<div id="album-win" class="window">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h2>–ê–ª—å–±–æ–º</h2><button onclick="toggleAlbum()" style="background:none;border:none;color:red;font-size:40px;">&times;</button></div>
    <div id="album-list" class="list-container"></div>
</div>

<div id="rank-win" class="window">
    <div style="display:flex; justify-content:space-between; align-items:center;"><h2>üèÜ –¢–û–ü</h2><button onclick="closeRank()" style="background:none;border:none;color:red;font-size:40px;">&times;</button></div>
    <div class="mode-tabs">
        <button id="tab-rank-easy" class="tab-btn" onclick="loadRank('easy')">–ü—Ä–æ—Å—Ç–∏–π</button>
        <button id="tab-rank-medium" class="tab-btn" onclick="loadRank('medium')">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
        <button id="tab-rank-realism" class="tab-btn" onclick="loadRank('realism')">–†–µ–∞–ª—ñ–∑–º</button>
    </div>
    <div id="rank-list" class="list-container"></div>
</div>

<div id="container3d"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const FB_URL = "https://numismatis-c1cce-default-rtdb.europe-west1.firebasedatabase.app/";
    let money = 0, xp = 0, myCoins = [], currentCoin = null, config = {}, currentModeId = '';
    const AUC_TIME = 24 * 60 * 60 * 1000;
    let aucListener = null;

    // --- 3D ENGINE ---
    const scene = new THREE.Scene();
    const container = document.getElementById('container3d');
    const camera = new THREE.PerspectiveCamera(40, container.clientWidth/container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    const light = new THREE.DirectionalLight(0xffffff, 2.5); light.position.set(2,2,5); scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const coinMesh = new THREE.Mesh(new THREE.CylinderGeometry(2,2,0.18,64), [new THREE.MeshStandardMaterial({color:0xaa8800}), new THREE.MeshStandardMaterial(), new THREE.MeshStandardMaterial()]);
    coinMesh.rotation.z = Math.PI/2;
    const pivot = new THREE.Group(); pivot.add(coinMesh); scene.add(pivot);
    camera.position.set(0,0,11);

    function createTex(t, l, isG, isAv, isIn, rot=0) {
        const can = document.createElement('canvas'); can.width=512; can.height=512;
        const c = can.getContext('2d');
        c.fillStyle = isG ? '#ffd700' : '#dcdcdc'; c.beginPath(); c.arc(256,256,250,0,Math.PI*2); c.fill();
        c.save(); c.translate(256,256); if(isAv) c.scale(-1,-1); c.fillStyle='rgba(0,0,0,0.8)'; c.textAlign='center';
        if(isIn){ c.scale(-1,1); c.font='bold 120px Arial'; c.fillText("UA",0,40); }
        else { c.font='bold 150px Arial'; c.fillText(t,0,30); c.font='bold 60px Arial'; c.fillText(l,0,110); }
        c.restore(); 
        const tex = new THREE.CanvasTexture(can); if(rot) { tex.center.set(0.5,0.5); tex.rotation=(rot*Math.PI)/180; }
        return tex;
    }

    function update3D(n, y, inc=false, rot=0) {
        coinMesh.material[1].map = createTex(n.toString(), "–∫–æ–ø.", n>=10, false, inc, rot);
        coinMesh.material[2].map = createTex("UA", y.toString(), n>=10, true, false, 0);
        coinMesh.material[1].needsUpdate = true; coinMesh.material[2].needsUpdate = true;
    }

    // --- GAMEPLAY CORE ---
    function startGame(m) {
        currentModeId = m;
        config = {easy:{s:10,w:100,r:0.3}, medium:{s:40,w:60,r:0.15}, realism:{s:80,w:40,r:0.05}}[m];
        const s = JSON.parse(localStorage.getItem('numizmat_'+m) || '{"m":200,"x":0,"a":[]}');
        money=s.m; 
        xp=s.x || 0; // Fix XP undefined
        myCoins=s.a;
        document.getElementById('menu').style.display='none';
        document.getElementById('ui-layer').style.display='block';
        document.getElementById('current-mode-label').innerText = m === 'easy' ? '–ü—Ä–æ—Å—Ç–∏–π' : m === 'medium' ? '–°–µ—Ä–µ–¥–Ω—ñ–π' : '–†–µ–∞–ª—ñ–∑–º';
        updateUI();
        checkMyAuctionResults();
        if(!window.passiveTimer) window.passiveTimer = setInterval(passiveIncome, 60000);
    }

    function updateUI() {
        document.getElementById('money-val').innerText = Math.floor(money || 0);
        document.getElementById('xp-val').innerText = xp || 0; // Fix XP undefined
        
        let totalP = 0;
        myCoins.forEach(c => { if(c && c.rare) totalP += c.price * 0.001; });
        const passDisp = document.getElementById('passive-in-balance');
        passDisp.innerText = `(+‚Ç¥${totalP.toFixed(1)})`;
        passDisp.style.display = totalP > 0 ? "inline" : "none";

        document.getElementById('work-btn').innerText = `–†–æ–±–æ—Ç–∞\n+‚Ç¥${config.w}`;
        document.getElementById('search-btn').innerText = `–ü–æ—à—É–∫\n-‚Ç¥${config.s}`;
        sync();
    }

    function passiveIncome() {
        let inc = 0;
        myCoins.forEach(c => { if(c && c.rare) inc += c.price * 0.001; });
        if(inc > 0) {
            money += inc; updateUI(); save();
            const notice = document.getElementById('passive-notice');
            notice.innerText = `+‚Ç¥${inc.toFixed(1)}`;
            notice.style.opacity = "1";
            setTimeout(() => notice.style.opacity = "0", 3000);
        }
    }

    // --- –ê–£–ö–¶–Ü–û–ù ---
    async function openAuction() {
    if (!currentModeId) startGame('easy');
    document.getElementById('auc-win').style.display = 'flex';
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ "–∂–∏–≤–µ" –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 3 —Å–µ–∫—É–Ω–¥–∏
    if (aucListener) clearInterval(aucListener);
    refreshAuc(currentModeId); // –ü–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫
    aucListener = setInterval(() => refreshAuc(currentModeId, true), 3000); 
}

async function refreshAuc(mode, isSilent = false) {
    if (currentModeId !== mode && !isSilent) { save(); startGame(mode); }
    const list = document.getElementById('auc-list');
    if (!isSilent) list.innerHTML = "–û–Ω–æ–≤–ª–µ–Ω–Ω—è...";
    
    document.querySelectorAll('#auc-win .tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-auc-' + mode).classList.add('active');

    try {
        const res = await fetch(`${FB_URL}/auctions/${mode}.json`);
        const data = await res.json();
        const nick = localStorage.getItem('playerName');
        let html = "";
        let found = false;

        if (data) {
            Object.keys(data).forEach(id => {
                const a = data[id];
                if (!a || a.status === 'settled') return;

                // --- –ë–õ–û–ö –ü–û–í–ï–†–ù–ï–ù–ù–Ø –ì–†–û–®–ï–ô ---
                const storageKey = `bid_locked_${id}`;
                const lockedAmount = parseFloat(localStorage.getItem(storageKey) || 0);
                if (lockedAmount > 0 && a.lastBidder !== nick) {
                money += lockedAmount;
                localStorage.removeItem(storageKey);
                 alert(`–í–∞—à—É —Å—Ç–∞–≤–∫—É –Ω–∞ ${a.coin.n}–∫ –ø–µ—Ä–µ–±–∏—Ç–æ! ‚Ç¥${lockedAmount} –ø–æ–≤–µ—Ä–Ω–µ–Ω–æ.`);
                updateUI();
                save();
                sync(); // (—â–æ–± —Ä–µ–π—Ç–∏–Ω–≥ –æ–Ω–æ–≤–∏–≤—Å—è –ø—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≥—Ä–æ—à–µ–π)
}
                
                // –Ø–∫—â–æ —É –Ω–∞—Å —î "–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ" –≥—Ä–æ—à—ñ, –∞–ª–µ –æ—Å—Ç–∞–Ω–Ω—ñ–π –±—ñ–¥–µ—Ä –≤–∂–µ –ù–ï –º–∏
                if (lockedAmount > 0 && a.lastBidder !== nick) {
                    money += lockedAmount;
                    localStorage.removeItem(storageKey); // –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–ø–∏—Å –ø—Ä–æ –±–ª–æ–∫
                    alert(`–í–∞—à—É —Å—Ç–∞–≤–∫—É –Ω–∞ ${a.coin.n}–∫ –ø–µ—Ä–µ–±–∏—Ç–æ! ‚Ç¥${lockedAmount} –ø–æ–≤–µ—Ä–Ω–µ–Ω–æ.`);
                    updateUI();
                    save();
                }
                // ------------------------------

                const timeLeft = Math.max(0, AUC_TIME - (Date.now() - a.startTime));
                const h = Math.floor(timeLeft / 3600000), m = Math.floor((timeLeft % 3600000) / 60000), s = Math.floor((timeLeft % 60000) / 1000);
                
                const isMine = a.seller === nick;
                const isMyBid = a.lastBidder === nick;
                let btnStyle = isMyBid ? "background:#2ecc71; color:white;" : "background:var(--gold); color:black;";

                html += `<div class="list-row">
    <div style="flex:1">
        <b>${a.coin.n}–∫ ${a.coin.y}</b> <small style="color:var(--gold)">[${a.coin.e}]</small><br>
        <small>üë§ ${a.seller}</small><br>
        <small style="color:${timeLeft < 600000 ? '#e74c3c' : '#2ecc71'}">‚è≥ ${h}–≥ ${m}—Ö–≤ ${s}—Å</small>
    </div>
    <div style="text-align:right; min-width:100px;">
        <b style="color:var(--gold); font-size:14px;">‚Ç¥${a.currentBid}</b><br>
        <small style="color:#666; display:block; margin-bottom:4px;">–û—Ü—ñ–Ω–∫–∞: ‚Ç¥${a.coin.price}</small>
        ${isMine ? `<div style="color:#888; font-size:10px; border:1px solid #444; padding:2px; border-radius:4px; text-align:center;">–í–õ–ê–°–ù–ò–ö</div>` : 
        `<button class="nav-btn" style="width:80px; padding:6px; ${btnStyle}" onclick="makeBid('${mode}', '${id}', ${a.currentBid})">${isMyBid ? '–í–ê–®–ê' : '–°–¢–ê–í–ö–ê'}</button>`}
    </div>
</div>`;
                found = true;
            });
        }
        list.innerHTML = found ? html : "<center style='margin-top:20px; color:#666;'>–ù–µ–º–∞—î –ª–æ—Ç—ñ–≤</center>";
    } catch (e) { if (!isSilent) list.innerHTML = "–ü–æ–º–∏–ª–∫–∞"; }
}
async function makeBid(mode, lotId, current) {
    const nick = localStorage.getItem('playerName');
    const nextBid = Math.ceil(current * 1.1);
    
    try {
        const res = await fetch(`${FB_URL}/auctions/${mode}/${lotId}.json`);
        const lot = await res.json();
        
        if (lot.currentBid > current) {
            alert("–°—Ç–∞–≤–∫—É –≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–æ!");
            refreshAuc(mode);
            return;
        }

        // –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ, —Å–∫—ñ–ª—å–∫–∏ —Ä–µ–∞–ª—å–Ω–æ –∑–Ω—è—Ç–∏ –∑ –≥–∞–º–∞–Ω—Ü—è –∑–∞—Ä–∞–∑
        const storageKey = `bid_locked_${lotId}`;
        const alreadyLocked = parseFloat(localStorage.getItem(storageKey) || 0);
        
        // –Ø–∫—â–æ –º–∏ –≤–∂–µ –ª—ñ–¥–∏—Ä—É—î–º–æ, –ø–ª–∞—Ç–∏–º–æ —Ç—ñ–ª—å–∫–∏ —Ä—ñ–∑–Ω–∏—Ü—é. –Ø–∫—â–æ –Ω—ñ ‚Äî –ø–ª–∞—Ç–∏–º–æ –ø–æ–≤–Ω—É –Ω–æ–≤—É —Å—Ç–∞–≤–∫—É.
        const toPay = (lot.lastBidder === nick) ? (nextBid - alreadyLocked) : nextBid;

        if (money < toPay) {
            alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!");
            return;
        }

        if (confirm(`–°—Ç–∞–≤–∫–∞: ‚Ç¥${nextBid}. –î–æ —Å–ø–ª–∞—Ç–∏: ‚Ç¥${toPay}`)) {
            await fetch(`${FB_URL}/auctions/${mode}/${lotId}.json`, { 
                method: 'PATCH', 
                body: JSON.stringify({ currentBid: nextBid, lastBidder: nick }) 
            });

            money -= toPay;
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤ –ø–∞–º'—è—Ç—ñ, —Å–∫—ñ–ª—å–∫–∏ –≥—Ä–æ—à–µ–π –º–∏ "–∑–∞–º–æ—Ä–æ–∑–∏–ª–∏" –≤ —Ü—å–æ–º—É –ª–æ—Ç—ñ
            localStorage.setItem(storageKey, nextBid); 
            
            updateUI(); save(); sync(); refreshAuc(mode);
        }
    } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞"); }
}

    // --- –†–ï–ô–¢–ò–ù–ì ---
    function openRank() { document.getElementById('rank-win').style.display = 'flex'; loadRank(currentModeId || 'easy'); }
    async function loadRank(m) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
        document.querySelectorAll('#rank-win .tab-btn').forEach(b => b.classList.remove('active'));
        const activeTab = document.getElementById('tab-rank-' + m);
        if(activeTab) activeTab.classList.add('active');
        try {
            const res = await fetch(`${FB_URL}/leaderboard/${m}.json`);
            const d = await res.json();
            list.innerHTML = "";
            if(d) {
                // –§—ñ–ª—å—Ç—Ä –≤—ñ–¥ undefined
                Object.values(d).filter(u => u && u.name).sort((a,b) => (b.money || 0) - (a.money || 0)).slice(0, 15).forEach((u, i) => {
                    list.innerHTML += `<div class="list-row"><span>${i+1}. <b>${u.name}</b></span><b style="color:var(--gold)">‚Ç¥${Math.floor(u.money || 0)}</b></div>`;
                });
            } else { list.innerHTML = "–ü—É—Å—Ç–æ"; }
        } catch(e) { list.innerHTML = "–ü–æ–º–∏–ª–∫–∞"; }
    }

    // --- –ê–õ–¨–ë–û–ú –¢–ê –ü–†–û–î–ê–ñ ---
    function toggleAlbum() {
        const win = document.getElementById('album-win');
        if (win.style.display === 'flex') {
            win.style.display = 'none';
        } else {
            win.style.display = 'flex';
            renderAlbumList();
        }
    }

    function renderAlbumList() {
        const list = document.getElementById('album-list');
        list.innerHTML = '';
        if (myCoins.length === 0) {
            list.innerHTML = "<center style='margin-top:20px; color:#666;'>–ê–ª—å–±–æ–º –ø–æ—Ä–æ–∂–Ω—ñ–π</center>";
            return;
        }
        myCoins.forEach((c, i) => {
            if(!c) return;
            list.innerHTML += `<div class="list-row" onclick="update3D(${c.n},${c.y},${c.inc},${c.rot})">
                <div style="flex:1"><b>${c.n}–∫ ${c.y}</b><br><small>${c.e}</small><br><b style="color:var(--gold)">‚Ç¥${c.price}</b></div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button class="nav-btn btn-blue" style="padding:5px;" onclick="event.stopPropagation(); sellFromAlbum(${i})">–ü–†–û–î–ê–¢–ò</button>
                    ${c.rare ? `<button class="nav-btn btn-orange" style="padding:5px;" onclick="event.stopPropagation(); prepareAuction(${i})">–ê–£–ö–¶–Ü–û–ù</button>` : ''}
                </div>
            </div>`;
        });
    }

    function sellFromAlbum(i) {
        money += myCoins[i].price;
        myCoins.splice(i, 1);
        updateUI();
        save();
        sync();
        renderAlbumList(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –±–µ–∑ –∑–∞–∫—Ä–∏—Ç—Ç—è –≤—ñ–∫–Ω–∞
    }

    async function prepareAuction(i) {
        const c = myCoins[i];
        const userPrice = prompt(`–í–∞—à–∞ —Ü—ñ–Ω–∞ –∑–∞ ${c.n}–∫ ${c.y}? (–û—Ü—ñ–Ω–∫–∞: ‚Ç¥${c.price})`, c.price);
        if (userPrice && !isNaN(userPrice) && userPrice > 0) {
            const nick = localStorage.getItem('playerName');
            const lotId = `${Date.now()}_${nick.replace(/[^a-z0-9]/gi,'')}`;
            const lotData = { seller: nick, coin: c, startPrice: parseInt(userPrice), currentBid: parseInt(userPrice), startTime: Date.now(), status: 'active', mode: currentModeId };
            try {
                await fetch(`${FB_URL}/auctions/${currentModeId}/${lotId}.json`, { method:'PUT', body: JSON.stringify(lotData) });
                myCoins.splice(i, 1);
                save(); 
                sync(); 
                renderAlbumList();
                alert("–í–∏—Å—Ç–∞–≤–ª–µ–Ω–æ!");
            } catch(e) { alert("–ü–æ–º–∏–ª–∫–∞"); }
        }
    }

    // --- –°–ï–†–í–Ü–°–ù–Ü –§–£–ù–ö–¶–Ü–á ---
    function search() {
        if(money < config.s) return; money -= config.s;
        const noms = [1,2,5,10,25,50], n = noms[Math.floor(Math.random()*noms.length)], y = 1992 + Math.floor(Math.random()*28);
        let isR=false, p=n+5, e="–û–±—ñ–≥–æ–≤–∞", rt=0, ic=false;
        if(Math.random()<config.r) { isR=true; if(Math.random()>0.8){ ic=true; p=5000; e="–Ü–Ω–∫—É–∑"; } else { rt=[90,180,270][Math.floor(Math.random()*3)]; p=rt==180?1500:600; e=`–ü–æ–≤–æ—Ä–æ—Ç ${rt}¬∞`; } }
        currentCoin = {n,y,e,price:p,rare:isR,rot:rt,inc:ic};
        update3D(n,y,ic,rt); document.getElementById('modal').style.display='block';
        document.getElementById('coin-desc').innerHTML = `${n} –∫–æ–ø. ${y}<br>‚Ç¥${p}<br><small>${e}</small>`;
    }

    function work() { if(xp>=8){ xp-=8; money+=config.w; updateUI(); save(); sync(); } }
    function keepFound() { myCoins.push(currentCoin); xp+=10; closeModal(); }
    function sellFound() { money+=currentCoin.price; closeModal(); }
    function closeModal() { document.getElementById('modal').style.display='none'; updateUI(); save(); sync(); }
    function closeRank() { document.getElementById('rank-win').style.display='none'; }
    function closeAuc() {
    document.getElementById('auc-win').style.display = 'none';
    if (aucListener) {
        clearInterval(aucListener); // –ó—É–ø–∏–Ω—è—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è, –∫–æ–ª–∏ –≤—ñ–∫–Ω–æ –∑–∞–∫—Ä–∏—Ç–µ (–µ–∫–æ–Ω–æ–º–∏–º–æ —Ç—Ä–∞—Ñ—ñ–∫)
        aucListener = null;
    }
}
    function save() { if(currentModeId) localStorage.setItem('numizmat_'+currentModeId, JSON.stringify({m:money, x:xp, a:myCoins})); }
    async function sync() {
    const n = localStorage.getItem('playerName');
    if (n && currentModeId) {
        try {
            await fetch(`${FB_URL}/leaderboard/${currentModeId}/${n.replace(/[^a-z0-9]/gi,'')}.json`, {
                method: 'PATCH', 
                body: JSON.stringify({ name: n, money: Math.floor(money), xp: xp })
            });
        } catch(e) { console.error("–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó"); }
    }
}
    function resetGame() { if(confirm("–°–∫–∏–Ω—É—Ç–∏ –í–°–ï?")) { localStorage.clear(); location.reload(); } }

    async function checkMyAuctionResults() {
        const nick = localStorage.getItem('playerName'); if(!currentModeId) return;
        try {
            const res = await fetch(`${FB_URL}/auctions/${currentModeId}.json`);
            const data = await res.json(); if(!data) return;
            for(let id in data) {
                const a = data[id];
                if(a && a.status === 'active' && (Date.now() - a.startTime) > AUC_TIME) {
                    if(a.seller === nick) {
                        if(a.lastBidder) money += a.currentBid; else myCoins.push(a.coin);
                        await fetch(`${FB_URL}/auctions/${currentModeId}/${id}.json`, { method:'PATCH', body: JSON.stringify({status:'settled'}) });
                    } else if(a.lastBidder === nick) {
                        myCoins.push(a.coin);
                        await fetch(`${FB_URL}/auctions/${currentModeId}/${id}.json`, { method:'PATCH', body: JSON.stringify({status:'settled'}) });
                    }
                    save(); updateUI();sync();
                }
            }
        } catch(e) {}
    }

    function animate() { requestAnimationFrame(animate); pivot.rotation.y+=0.01; renderer.render(scene, camera); }
    window.onload = () => {
        let n = localStorage.getItem('playerName'); if(!n){ n=prompt("–í–∞—à –Ω—ñ–∫:"); localStorage.setItem('playerName', n||'User'); }
        document.getElementById('player-display').innerText = "–ì—Ä–∞–≤–µ—Ü—å: " + n;
        update3D(10, 2026); animate();
    };
</script>
</body>
</html>
