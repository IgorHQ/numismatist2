<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ù—É–º—ñ–∑–º–∞—Ç Pro Fix</title>
    <style>
        :root { --gold: #f1c40f; --blue: #3498db; --ios-bottom: calc(45px + env(safe-area-inset-bottom, 20px)); }
        body { margin: 0; height: 100svh; overflow: hidden; background: #000; font-family: -apple-system, system-ui, sans-serif; color: white; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
        
        #container3d { position: absolute; top: 0; left: 0; width: 100%; height: 60svh; z-index: 1; }
        #ui-layer { display: none; position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        #ui-layer button, #modal, #album-window, #leaderboard-window { pointer-events: auto; }
        
        #top-bar { position: absolute; top: calc(10px + env(safe-area-inset-top, 20px)); left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; }
        .stat { background: rgba(30,30,30,0.85); padding: 6px 10px; border-radius: 10px; border: 1px solid var(--gold); font-size: 12px; font-weight: bold; }
        
        /* –°—Ç–∏–ª—ñ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –∑ –≤–µ—Ä—Å—ñ—ó indexNew */
        #modal {
            display: none; position: absolute; bottom: calc(75px + var(--ios-bottom)); left: 50%; transform: translateX(-50%);
            background: rgba(20,20,20,0.96); padding: 12px 15px; border-radius: 18px; text-align: center; border: 1px solid var(--gold); 
            width: 78%; max-width: 250px; box-shadow: 0 5px 25px rgba(0,0,0,0.7); z-index: 100;
        }

        .main-nav { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 10px 15px var(--ios-bottom) 15px; background: linear-gradient(transparent, rgba(0,0,0,0.98) 50%); }
        .nav-btn { flex: 1; padding: 18px 5px; border-radius: 15px; border: none; font-weight: bold; font-size: 10px; line-height: 1.3; white-space: pre-line; cursor: pointer; }
        .btn-blue { background: #3498db; color: white; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-purple { background: #9b59b6; color: white; }

        #menu { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-btn { width: 80%; padding: 18px; margin: 8px; border-radius: 15px; border: 2px solid var(--gold); background: #111; color: white; font-size: 18px; font-weight: bold; cursor: pointer; }

        #album-window, #leaderboard-window { display: none; position: fixed; inset: 0; background: #111; z-index: 4000; padding: calc(20px + env(safe-area-inset-top)) 20px; flex-direction: column; }
        .tabs { display: flex; gap: 5px; margin-top: 15px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #444; background: #222; color: #888; font-size: 11px; }
        .tab-btn.active { background: var(--gold); color: black; }
        .list-container { flex: 1; overflow-y: auto; margin-top: 15px; }
        .list-row { background: #1a1a1a; margin-bottom: 8px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; border: 1px solid #333; align-items: center;}
        
        .loader { width: 30px; height: 30px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button:active { transform: scale(0.95); opacity: 0.8; }
        button:disabled { opacity: 0.3; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="color:var(--gold); letter-spacing: 2px; margin-bottom: 30px;">–ù–£–ú–Ü–ó–ú–ê–¢</h1>
    <div id="player-box" style="text-align: center; margin-bottom: 20px;">
        <p id="player-display" style="font-size: 13px; color: #aaa;"></p>
        <button onclick="changeNickname()" style="color:var(--blue); background:none; border:none; text-decoration:underline; font-size: 11px;">–ó–º—ñ–Ω–∏—Ç–∏ –∞–∫–∞—É–Ω—Ç</button>
    </div>
    <button class="menu-btn" onclick="startGame('easy')">–ü—Ä–æ—Å—Ç–∏–π</button>
    <button class="menu-btn" onclick="startGame('medium')">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
    <button class="menu-btn" onclick="startGame('realism')">–†–µ–∞–ª—ñ–∑–º</button>
    <button class="menu-btn" style="border-color:#3498db; margin-top: 20px;" onclick="openLeaderboard()">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
</div>

<div id="leaderboard-window">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0">üèÜ –¢–û–ü-10</h2>
        <button onclick="closeLeaderboard()" style="color:red; background:none; border:none; font-size:40px; line-height:1;">&times;</button>
    </div>
    <div class="tabs">
        <button id="tab-easy" class="tab-btn" onclick="loadLeaderboard('easy')">–ü—Ä–æ—Å—Ç–∏–π</button>
        <button id="tab-medium" class="tab-btn" onclick="loadLeaderboard('medium')">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
        <button id="tab-realism" class="tab-btn" onclick="loadLeaderboard('realism')">–†–µ–∞–ª—ñ–∑–º</button>
    </div>
    <div id="leaderboard-list" class="list-container"></div>
</div>

<div id="container3d"></div>

<div id="ui-layer">
    <div id="top-bar">
        <div style="display:flex; gap:8px;">
            <div class="stat">‚Ç¥ <span id="money-val">0</span></div>
            <div class="stat">XP <span id="xp-val" style="color:var(--blue)">0</span></div>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="stat" style="background:rgba(231,76,60,0.2); border:1px solid #e74c3c; color:#e74c3c;" onclick="resetThisMode()">Reset</button>
            <button class="stat" style="background:#333; color:white; border:none;" onclick="location.reload()">–ú–µ–Ω—é</button>
        </div>
    </div>

    <div id="modal">
        <h3 id="m-title" style="margin:0; color:var(--gold); font-size: 15px; text-transform: uppercase;"></h3>
        <div id="coin-desc" style="margin: 8px 0; font-size:14px; line-height: 1.4;"></div>
        <div style="display:flex; gap:8px; margin-top:5px;">
            <button class="nav-btn btn-blue" style="padding:10px 0; font-size:11px;" onclick="keepFound()">–í –ê–ª—å–±–æ–º</button>
            <button class="nav-btn" style="padding:10px 0; font-size:11px; background:#444; color:white;" onclick="sellFound()">–ü—Ä–æ–¥–∞—Ç–∏</button>
        </div>
    </div>

    <div id="album-window">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">–í–∞—à –ê–ª—å–±–æ–º</h2>
            <button onclick="toggleAlbum()" style="background:none; border:none; color:#ff4757; font-size:40px;">&times;</button>
        </div>
        <div id="album-list" class="list-container"></div>
    </div>

    <nav class="main-nav">
        <button id="work-btn" class="nav-btn btn-blue" onclick="work()"></button>
        <button id="search-btn" class="nav-btn btn-gold" onclick="search()"></button>
        <button class="nav-btn btn-purple" onclick="toggleAlbum()">–ê–ª—å–±–æ–º</button>
    </nav>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const FB_URL = "https://numismatis-c1cce-default-rtdb.europe-west1.firebasedatabase.app/";
    let money = 0, xp = 0, myCoins = [], currentCoin = null, config = {}, currentModeId = '';
    
    const modes = { 
        easy: { search: 10, work: 100, rareChance: 0.3, garbageMin: 10, startMoney: 200 }, 
        medium: { search: 40, work: 60, rareChance: 0.15, garbageMin: 5, startMoney: 200 }, 
        realism: { search: 80, work: 40, rareChance: 0.05, garbageMin: 1, startMoney: 1000 } 
    };

    // –†–æ–∑—à–∏—Ä–µ–Ω–∞ –±–∞–∑–∞ –∑ "–≥–∞—Ä–Ω–æ—ó" –≤–µ—Ä—Å—ñ—ó
    const COIN_DB = {
        1: { common: 1, rarities: [
            { y: 1994, price: 2500, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫ (300 —à—Ç)", xp: 500 },
            { y: 1996, price: 1000, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫ (–∑ –Ω–∞–±–æ—Ä—ñ–≤)", xp: 300 },
            { y: 1992, price: 4000, desc: "–®—Ç–∞–º–ø 1.11–ê–ï (–≤–µ–ª–∏–∫—ñ —è–≥–æ–¥–∏)", xp: 800 }
        ]},
        2: { common: 2, rarities: [
            { y: 1992, price: 25000, desc: "–í—É–∑—å–∫–∏–π –≤—ñ–Ω–æ–∫ (–®—Ç–∞–º–ø 1.1–ì–ê)", xp: 2000 },
            { y: 1996, price: 800, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫", xp: 250 },
            { y: 2003, price: 4500, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π –æ–±—ñ–≥–æ–≤–∏–π —Ä—ñ–∫", xp: 700 }
        ]},
        5: { common: 5, rarities: [
            { y: 1994, price: 3500, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫", xp: 600 },
            { y: 2001, price: 1000, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫", xp: 300 },
            { y: 1992, price: 5000, desc: "–ö—Ä—É–ø–Ω–∞ –Ω–∞—Å—ñ—á–∫–∞ –≥—É—Ä—Ç–∞", xp: 900 }
        ]},
        10: { common: 10, rarities: [
            { y: 2001, price: 1200, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫", xp: 300 },
            { y: 1992, price: 15000, desc: "–®—ñ—Å—Ç—å —è–≥—ñ–¥ (–®—Ç–∞–º–ø 1.14–ì–ê–º)", xp: 1500 }
        ]},
        25: { common: 25, rarities: [
            { y: 1995, price: 2000, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫", xp: 500 },
            { y: 1992, price: 3500, desc: "–ê–Ω–≥–ª—ñ–π—Å—å–∫–∏–π —á–µ–∫–∞–Ω (–≤—Ç–∏—Å–Ω—É—Ç–∏–π)", xp: 800 }
        ]},
        50: { common: 50, rarities: [
            { y: 1996, price: 1500, desc: "–†—ñ–¥–∫—ñ—Å–Ω–∏–π —Ä—ñ–∫", xp: 400 },
            { y: 1992, price: 6000, desc: "–¢—Ä–∞–ø–µ—Ü—ñ—ó (–®—Ç–∞–º–ø 1(2).1–ê–ì–º)", xp: 1000 }
        ]}
    };

    // --- –õ–û–ì–Ü–ö–ê –†–ï–ô–¢–ò–ù–ì–£ ---
    function openLeaderboard() {
        document.getElementById('leaderboard-window').style.display = 'flex';
        loadLeaderboard(currentModeId || 'easy');
    }

    function closeLeaderboard() { document.getElementById('leaderboard-window').style.display = 'none'; }

    async function loadLeaderboard(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        const tab = document.getElementById('tab-' + mode);
        if (tab) tab.classList.add('active');
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = `<div class="loader"></div>`;
        try {
            const res = await fetch(`${FB_URL}/leaderboard/${mode}.json?orderBy="money"&limitToLast=10&t=${Date.now()}`);
            const data = await res.json();
            list.innerHTML = "";
            if (!data) { list.innerHTML = "–ü–æ—Ä–æ–∂–Ω—å–æ"; return; }
            const sorted = Object.values(data).filter(u => u && u.money !== undefined).sort((a,b) => b.money - a.money);
            sorted.forEach((u, i) => {
                const isMe = u.name === localStorage.getItem('playerName') ? "border:1px solid var(--gold); background:rgba(255,215,0,0.1);" : "";
                list.innerHTML += `<div class="list-row" style="${isMe}"><span><b>${i+1}.</b> ${u.name}</span><b>‚Ç¥${u.money}</b></div>`;
            });
        } catch (e) { list.innerHTML = "–ü–æ–º–∏–ª–∫–∞"; }
    }

    // --- –õ–û–ì–Ü–ö–ê –ì–†–ò –¢–ê –û–¶–Ü–ù–ö–ò (–ó –í–ï–†–°–Ü–á indexNew) ---
    function search() {
        if (money < config.search) return;
        money -= config.search;

        const nominals = [1, 2, 5, 10, 25, 50];
        const n = nominals[Math.floor(Math.random() * nominals.length)];
        const y = 1992 + Math.floor(Math.random() * 32); 

        let price = 0, statusText = "", isR = false, xpGain = 5, rot = 0, isI = false;

        const rareMatch = COIN_DB[n].rarities.find(r => r.y === y);
        if (rareMatch && Math.random() < 0.15) {
            isR = true; statusText = rareMatch.desc; price = rareMatch.price; xpGain = rareMatch.xp;
        } 
        else if (Math.random() < config.rareChance) {
            isR = true;
            if (Math.random() < 0.1) {
                statusText = "–Ü–Ω–∫—É–∑–Ω–µ –∫–∞—Ä–±—É–≤–∞–Ω–Ω—è"; price = 4500; isI = true; xpGain = 600;
            } else {
                rot = [90, 180, 270][Math.floor(Math.random() * 3)];
                statusText = `–ü–æ–≤–æ—Ä–æ—Ç ${rot}¬∞`; price = 280 + Math.floor(Math.random() * 300); xpGain = 60;
            }
        } 
        else {
            statusText = "–ì–∞—Ä–Ω–∏–π —Å—Ç–∞–Ω";
            price = COIN_DB[n].common + config.garbageMin + Math.floor(Math.random() * 10);
            xpGain = 5;
        }

        currentCoin = { n, y, e: statusText, price, rare: isR, rot, inc: isI, xp: xpGain };
        update3D(n, y, isI, rot);
        
        document.getElementById('m-title').innerText = isR ? "‚≠ê –†–ê–†–ò–¢–ï–¢ ‚≠ê" : "–ó–Ω–∞–π–¥–µ–Ω–æ –º–æ–Ω–µ—Ç—É";
        document.getElementById('coin-desc').innerHTML = `<br><b>${n} –∫–æ–ø. ${y} —Ä–æ–∫—É</b><br><br>–°—Ç–∞–Ω: <span style="color:${isR ? 'var(--gold)' : '#3498db'}; font-weight:bold;">${statusText}</span><br><br>–û—Ü—ñ–Ω–∫–∞: <span style="color:#2ecc71; font-weight:bold; font-size:15px;">${price} ‚Ç¥</span><br>`;
        document.getElementById('modal').style.display = 'block';
        updateUI(); saveProgress(); syncOnline();
    }

    function work() { if(xp >= 8) { xp -= 8; money += config.work; updateUI(); saveProgress(); syncOnline(); } }
    
    function startGame(mode) {
        closeLeaderboard();
        currentModeId = mode; config = modes[mode];
        const saved = localStorage.getItem('numizmat_' + mode);
        if (saved) { const d = JSON.parse(saved); money = d.m; xp = d.x; myCoins = d.a || []; } 
        else { money = config.startMoney; xp = 0; myCoins = []; }
        document.getElementById('menu').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        updateUI(); syncOnline();
    }

    // --- 3D –¢–ê –Ü–ù–¢–ï–†–§–ï–ô–° ---
    const container = document.getElementById('container3d');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(40, container.clientWidth/container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    const light = new THREE.DirectionalLight(0xffffff, 2.5); light.position.set(2, 2, 5); scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const coinMesh = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 0.18, 64), [new THREE.MeshStandardMaterial({color: 0xaa8800}), new THREE.MeshStandardMaterial(), new THREE.MeshStandardMaterial()]);
    coinMesh.rotation.z = Math.PI/2;
    const pivot = new THREE.Group(); pivot.add(coinMesh); scene.add(pivot);
    camera.position.set(0, 0, 11);

    function createFace(text, label, isGold, isAvers, isIncuse, rot = 0) {
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = isGold ? '#ffd700' : '#dcdcdc'; ctx.beginPath(); ctx.arc(256, 256, 250, 0, Math.PI*2); ctx.fill();
        ctx.save(); ctx.translate(256, 256); if (isAvers) ctx.scale(-1, -1); ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.textAlign = 'center';
        if (isIncuse) { ctx.scale(-1, 1); ctx.font = 'bold 120px Arial'; ctx.fillText("UA", 0, 40); } 
        else { ctx.font = 'bold 160px Arial'; ctx.fillText(text, 0, 30); ctx.font = 'bold 60px Arial'; ctx.fillText(label, 0, 110); }
        ctx.restore(); 
        const tex = new THREE.CanvasTexture(canvas);
        if (rot !== 0) { tex.center.set(0.5, 0.5); tex.rotation = (rot * Math.PI) / 180; }
        return tex;
    }

    function update3D(n, y, isInc, rot) {
        const isG = n >= 10;
        coinMesh.material[1].map = createFace(n, "–∫–æ–ø.", isG, false, isInc, rot);
        coinMesh.material[2].map = createFace("UA", y.toString(), isG, true, false, 0);
        coinMesh.material[1].needsUpdate = true; coinMesh.material[2].needsUpdate = true;
    }

    async function syncOnline() {
        const name = localStorage.getItem('playerName');
        if (!name || !currentModeId) return;
        const data = { name, money, xp, pin: localStorage.getItem('playerPin'), album: myCoins, lastUpdate: Date.now() };
        try { await fetch(`${FB_URL}/leaderboard/${currentModeId}/${name}.json`, { method: 'PATCH', body: JSON.stringify(data) }); } catch (e) {}
    }

    async function checkLogin() {
        let name = localStorage.getItem('playerName');
        if (!name) {
            name = prompt("–ù—ñ–∫–Ω–µ–π–º:"); if (!name) return checkLogin();
            name = name.replace(/[.#$[\]]/g, "").substring(0, 12);
            const res = await fetch(`${FB_URL}/users_auth/${name}.json`);
            const auth = await res.json();
            if (auth) {
                let pin = prompt("PIN:");
                if (pin === auth.pin) { localStorage.setItem('playerName', name); localStorage.setItem('playerPin', pin); location.reload(); }
                else { alert("–ü–æ–º–∏–ª–∫–∞!"); return checkLogin(); }
            } else {
                let pin = prompt("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ PIN:");
                localStorage.setItem('playerName', name); localStorage.setItem('playerPin', pin || "0000");
                await fetch(`${FB_URL}/users_auth/${name}.json`, { method: 'PUT', body: JSON.stringify({ pin: pin || "0000" }) });
            }
        }
        document.getElementById('player-display').innerText = "–ì—Ä–∞–≤–µ—Ü—å: " + name;
    }

    function keepFound() { myCoins.push(currentCoin); xp += (currentCoin.xp || 5); closeModal(); }
    function sellFound() { money += currentCoin.price; closeModal(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; updateUI(); saveProgress(); syncOnline(); }
    function toggleAlbum() { const w = document.getElementById('album-window'); w.style.display = (w.style.display==='flex')?'none':'flex'; if(w.style.display==='flex') renderAlbum(); }
    
    function renderAlbum() {
        const list = document.getElementById('album-list'); list.innerHTML = '';
        myCoins.forEach((c, i) => {
            const row = document.createElement('div'); row.className = 'list-row';
            row.innerHTML = `<div><b>${c.n}–∫ ${c.y}</b><br><small style="color:${c.rare?'var(--gold)':'#888'}">${c.e}</small></div><button style="background:#e74c3c; color:white; border:none; padding:8px 12px; border-radius:10px; font-weight:bold;" onclick="sellFromAlbum(${i}, event)">${c.price}‚Ç¥</button>`;
            row.onclick = () => { update3D(c.n, c.y, c.inc, c.rot); toggleAlbum(); };
            list.appendChild(row);
        });
    }

    function sellFromAlbum(i, e) { e.stopPropagation(); money += myCoins[i].price; myCoins.splice(i, 1); updateUI(); renderAlbum(); saveProgress(); syncOnline(); }
    function updateUI() { 
        document.getElementById('money-val').innerText = money; 
        document.getElementById('xp-val').innerText = xp;
        document.getElementById('work-btn').innerText = `–ü—Ä–∞—Ü—é–≤–∞—Ç–∏\n-8XP / +${config.work}‚Ç¥`;
        document.getElementById('search-btn').innerText = `–®—É–∫–∞—Ç–∏\n-${config.search}‚Ç¥`;
        document.getElementById('work-btn').disabled = xp < 8;
        document.getElementById('search-btn').disabled = money < config.search;
    }
    function saveProgress() { localStorage.setItem('numizmat_' + currentModeId, JSON.stringify({ m: money, x: xp, a: myCoins })); }
    function changeNickname() { localStorage.clear(); location.reload(); }
    async function resetThisMode() { if(confirm("–°–∫–∏–Ω—É—Ç–∏?")) { const n = localStorage.getItem('playerName'); if(n) await fetch(`${FB_URL}/leaderboard/${currentModeId}/${n}.json`, { method:'DELETE' }); localStorage.removeItem('numizmat_' + currentModeId); location.reload(); } }
    function animate() { requestAnimationFrame(animate); pivot.rotation.y += 0.015; renderer.render(scene, camera); }
    animate(); window.onload = checkLogin;
</script>
</body>
</html>
