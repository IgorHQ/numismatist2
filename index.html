<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ù—É–º—ñ–∑–º–∞—Ç Pro</title>
    <style>
        :root { --gold: #f1c40f; --blue: #3498db; --ios-bottom: calc(45px + env(safe-area-inset-bottom, 20px)); }
        body { margin: 0; height: 100svh; overflow: hidden; background: #000; font-family: -apple-system, system-ui, sans-serif; color: white; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
        #container3d { position: absolute; top: 0; left: 0; width: 100%; height: 55svh; z-index: 1; }
        #ui-layer { display: none; position: absolute; inset: 0; z-index: 10; pointer-events: none; }
        #ui-layer button, #modal, #album-window, #leaderboard-window, #auction-window { pointer-events: auto; }
        
        #top-bar { position: absolute; top: calc(10px + env(safe-area-inset-top, 20px)); left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: flex-start; }
        .stat-group { display: flex; flex-direction: column; gap: 4px; }
        .stat { background: rgba(30,30,30,0.85); padding: 6px 10px; border-radius: 10px; border: 1px solid var(--gold); font-size: 12px; font-weight: bold; min-width: 60px; text-align: center; }
        .income-tag { font-size: 10px; color: #2ecc71; font-weight: bold; margin-left: 5px; }

        .top-btns { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; }
        .btn-top { padding: 6px 12px; border-radius: 10px; border: none; font-size: 11px; font-weight: bold; color: white; cursor: pointer; min-width: 70px; }

        #modal { display: none; position: absolute; bottom: calc(100px + var(--ios-bottom)); left: 50%; transform: translateX(-50%); background: rgba(15,15,15,0.98); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid var(--gold); width: 85%; max-width: 280px; z-index: 100; box-shadow: 0 0 20px rgba(241, 196, 15, 0.2); }
        
        .main-nav { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 10px 15px var(--ios-bottom) 15px; background: linear-gradient(transparent, rgba(0,0,0,1) 70%); }
        .nav-btn { flex: 1; padding: 15px 5px; border-radius: 15px; border: none; font-weight: bold; font-size: 10px; line-height: 1.2; cursor: pointer; text-transform: uppercase; }
        .btn-blue { background: #3498db; color: white; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn-orange { background: #e67e22; color: white; }

        #menu { position: fixed; inset: 0; background: #000; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .menu-btn { width: 80%; padding: 18px; margin: 8px; border-radius: 15px; border: 2px solid var(--gold); background: #111; color: white; font-size: 18px; font-weight: bold; }

        #album-window, #leaderboard-window, #auction-window { display: none; position: fixed; inset: 0; background: #111; z-index: 5000; padding: calc(20px + env(safe-area-inset-top)) 20px; flex-direction: column; }
        .list-container { flex: 1; overflow-y: auto; margin-top: 15px; }
        .list-row { background: #1a1a1a; margin-bottom: 8px; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; border: 1px solid #333; align-items: center;}
        
        button:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>

<div id="menu">
    <h1 style="color:var(--gold); letter-spacing: 2px; margin-bottom: 10px;">–ù–£–ú–Ü–ó–ú–ê–¢</h1>
    <div id="player-box" style="text-align: center; margin-bottom: 20px;">
        <p id="player-display" style="font-size: 13px; color: #aaa;"></p>
        <button onclick="changeNickname()" style="color:var(--blue); background:none; border:none; text-decoration:underline; font-size: 11px;">–í–∏–π—Ç–∏</button>
    </div>
    <button class="menu-btn" onclick="startGame('easy')">–ü—Ä–æ—Å—Ç–∏–π</button>
    <button class="menu-btn" onclick="startGame('medium')">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
    <button class="menu-btn" onclick="startGame('realism')">–†–µ–∞–ª—ñ–∑–º</button>
    <button class="menu-btn" style="border-color:#3498db; margin-top: 15px;" onclick="openAuctionHouse()">üèõÔ∏è –ê–£–ö–¶–Ü–û–ù–ù–ò–ô –î–Ü–ú</button>
    <button class="menu-btn" style="border-color:#555; font-size: 14px;" onclick="openLeaderboard()">üèÜ –†–ï–ô–¢–ò–ù–ì</button>
</div>

<div id="ui-layer">
    <div id="top-bar">
        <div class="stat-group">
            <div class="stat">‚Ç¥ <span id="money-val">0</span><span id="rate-display" class="income-tag"></span></div>
            <div class="stat">XP <span id="xp-val" style="color:var(--blue)">0</span></div>
        </div>
        <div class="top-btns">
            <button class="btn-top" style="background:#444;" onclick="location.reload()">–ú–µ–Ω—é</button>
            <button class="btn-top" style="background:#c0392b;" onclick="changeNickname()">–ó–∞–Ω–æ–≤–æ</button>
        </div>
    </div>

    <div id="modal">
        <h3 id="m-title" style="margin:0; color:var(--gold); font-size:18px;"></h3>
        <div id="coin-desc" style="margin:10px 0; font-size:14px; line-height:1.4;"></div>
        <div style="display:flex; gap:8px;">
            <button class="nav-btn btn-blue" onclick="keepFound()">–í –ê–ª—å–±–æ–º</button>
            <button class="nav-btn" style="background:#444; color:white;" onclick="sellFound()">–ü—Ä–æ–¥–∞—Ç–∏</button>
        </div>
    </div>

    <nav class="main-nav">
        <button id="work-btn" class="nav-btn btn-blue" onclick="work()"></button>
        <button id="search-btn" class="nav-btn btn-gold" onclick="search()"></button>
        <button class="nav-btn btn-purple" onclick="toggleAlbum()">–ê–ª—å–±–æ–º</button>
    </nav>
</div>

<div id="album-window">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0">–ö–æ–ª–µ–∫—Ü—ñ—è</h2>
        <button onclick="toggleAlbum()" style="background:none; border:none; color:#ff4757; font-size:40px;">&times;</button>
    </div>
    <div id="album-list" class="list-container"></div>
</div>

<div id="auction-window">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0">–ê—É–∫—Ü—ñ–æ–Ω (48–≥)</h2>
        <button onclick="closeAuctionHouse()" style="background:none; border:none; color:#ff4757; font-size:40px;">&times;</button>
    </div>
    <div id="auction-list" class="list-container"></div>
</div>

<div id="leaderboard-window">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0">üèÜ –¢–û–ü-10</h2>
        <button onclick="closeLeaderboard()" style="color:red; background:none; border:none; font-size:40px;">&times;</button>
    </div>
    <div style="display:flex; gap:5px; margin-top:10px;">
        <button onclick="loadLeaderboard('easy')" style="flex:1; font-size:10px; padding:5px;">–õ–µ–≥–∫–∏–π</button>
        <button onclick="loadLeaderboard('medium')" style="flex:1; font-size:10px; padding:5px;">–°–µ—Ä–µ–¥–Ω—ñ–π</button>
        <button onclick="loadLeaderboard('realism')" style="flex:1; font-size:10px; padding:5px;">–†–µ–∞–ª</button>
    </div>
    <div id="leaderboard-list" class="list-container"></div>
</div>

<div id="container3d"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    const FB_URL = "https://numismatis-c1cce-default-rtdb.europe-west1.firebasedatabase.app/";
    let money = 0, xp = 0, myCoins = [], currentCoin = null, config = {}, currentModeId = '';

    // --- 3D ENGINE ---
    const container = document.getElementById('container3d');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(40, container.clientWidth/container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    const light = new THREE.DirectionalLight(0xffffff, 2.5); light.position.set(2, 2, 5); scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const coinMesh = new THREE.Mesh(new THREE.CylinderGeometry(2, 2, 0.18, 64), [new THREE.MeshStandardMaterial({color: 0xaa8800}), new THREE.MeshStandardMaterial(), new THREE.MeshStandardMaterial()]);
    coinMesh.rotation.z = Math.PI/2;
    const pivot = new THREE.Group(); pivot.add(coinMesh); scene.add(pivot);
    camera.position.set(0, 0, 11);

    function createFace(text, label, isGold, isAvers, isIncuse, rot = 0) {
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = isGold ? '#ffd700' : '#dcdcdc'; ctx.beginPath(); ctx.arc(256, 256, 250, 0, Math.PI*2); ctx.fill();
        ctx.save(); ctx.translate(256, 256); if (isAvers) ctx.scale(-1, -1); ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.textAlign = 'center';
        if (isIncuse) { ctx.scale(-1, 1); ctx.font = 'bold 120px Arial'; ctx.fillText("UA", 0, 40); } 
        else { ctx.font = `bold ${text.length > 5 ? '80px' : '160px'} Arial`; ctx.fillText(text, 0, 30); ctx.font = 'bold 60px Arial'; ctx.fillText(label, 0, 110); }
        ctx.restore(); 
        const tex = new THREE.CanvasTexture(canvas);
        if (rot !== 0) { tex.center.set(0.5, 0.5); tex.rotation = (rot * Math.PI) / 180; }
        return tex;
    }

    function update3D(n, y, isInc, rot) {
        const isG = (typeof n === 'number' && n >= 10) || n === "–ù–£–ú–Ü–ó–ú–ê–¢";
        coinMesh.material[1].map = createFace(n.toString(), n === "–ù–£–ú–Ü–ó–ú–ê–¢" ? "PRO" : "–∫–æ–ø.", isG, false, isInc, rot);
        coinMesh.material[2].map = createFace("UA", y.toString(), isG, true, false, 0);
        coinMesh.material[1].needsUpdate = true; coinMesh.material[2].needsUpdate = true;
    }

    // --- GAME LOGIC ---
    function startGame(mode) {
        currentModeId = mode; 
        config = { easy: {s:10, w:100, r:0.3}, medium: {s:40, w:60, r:0.15}, realism: {s:80, w:40, r:0.05} }[mode];
        const saved = JSON.parse(localStorage.getItem('numizmat_' + mode) || '{"m":200,"x":0,"a":[]}');
        money = saved.m; xp = saved.x; myCoins = saved.a;
        document.getElementById('menu').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        updateUI(); 
        finalizeAuctions();
        
        setInterval(() => {
            let inc = 0; myCoins.forEach(c => { if(c.rare) inc += c.price * 0.0001; });
            if (inc > 0) { money += inc; updateUI(); saveProgress(); syncOnline(); }
        }, 60000);
    }

    function updateUI() {
        document.getElementById('money-val').innerText = Math.floor(money);
        document.getElementById('xp-val').innerText = xp;
        document.getElementById('work-btn').innerText = `–†–æ–±–æ—Ç–∞\n+‚Ç¥${config.w}`;
        document.getElementById('search-btn').innerText = `–ü–æ—à—É–∫\n-‚Ç¥${config.s}`;
        let rate = 0; myCoins.forEach(c => { if(c.rare) rate += c.price * 0.0001; });
        document.getElementById('rate-display').innerText = rate > 0 ? `+‚Ç¥${rate.toFixed(2)}/—Ö–≤` : "";
    }

    async function finalizeAuctions() {
        try {
            const res = await fetch(`${FB_URL}/auctions.json`);
            const data = await res.json(); if (!data) return;
            const myName = localStorage.getItem('playerName');
            for (let id in data) {
                const a = data[id];
                if (Date.now() > a.endTime) {
                    if (a.highestBidder === myName) myCoins.push(a.coin);
                    else if (a.seller === myName) { if (a.highestBidder) money += a.currentBid; else myCoins.push(a.coin); }
                    await fetch(`${FB_URL}/auctions/${id}.json`, { method:'DELETE' });
                    saveProgress(); updateUI();
                }
            }
        } catch(e) {}
    }

    function search() {
        if (money < config.s) return;
        money -= config.s;
        const n = [1, 2, 5, 10, 25, 50][Math.floor(Math.random()*6)];
        const y = 1992 + Math.floor(Math.random()*30);
        let isR = Math.random() < config.r;
        currentCoin = { n, y, e: isR ? "–†—ñ–¥–∫—ñ—Å–Ω–∞ –æ—Å–æ–±–ª–∏–≤—ñ—Å—Ç—å" : "–ó–≤–∏—á–∞–π–Ω–∏–π –æ–±—ñ–≥", price: isR ? 1500 : n+10, rare: isR };
        update3D(n, y, false, 0);
        document.getElementById('m-title').innerText = isR ? "‚≠ê –†–ê–†–ò–¢–ï–¢ ‚≠ê" : "–ó–Ω–∞–π–¥–µ–Ω–æ –º–æ–Ω–µ—Ç—É";
        document.getElementById('coin-desc').innerHTML = `<b>${n} –∫–æ–ø. ${y} —Ä–æ–∫—É</b><br>–¶—ñ–Ω–∞: ‚Ç¥${currentCoin.price}<br><small>${currentCoin.e}</small>`;
        document.getElementById('modal').style.display = 'block';
        updateUI();
    }

    function toggleAlbum() { 
        const win = document.getElementById('album-window');
        win.style.display = win.style.display === 'flex' ? 'none' : 'flex';
        if(win.style.display === 'flex') {
            const list = document.getElementById('album-list'); list.innerHTML = '';
            myCoins.forEach((c, i) => {
                let auctionBtn = c.rare ? `<button onclick="startAuction(${i})" class="nav-btn btn-orange" style="width:85px; padding:8px; margin-right:5px">–ê–£–ö–¶–Ü–û–ù</button>` : '';
                list.innerHTML += `<div class="list-row">
                    <div style="flex:1" onclick="update3D(${c.n}, ${c.y}, false, 0); toggleAlbum();">
                        <b>${c.n}–∫ ${c.y}</b><br><small>${c.e}</small>
                    </div>
                    <div style="display:flex; align-items:center;">${auctionBtn}<button onclick="sellFromAlbum(${i})" class="nav-btn" style="background:#e74c3c; color:white; width:70px; padding:8px">‚Ç¥${c.price}</button></div>
                </div>`;
            });
        }
    }

    function openLeaderboard() { document.getElementById('leaderboard-window').style.display = 'flex'; loadLeaderboard(currentModeId || 'easy'); }
    function closeLeaderboard() { document.getElementById('leaderboard-window').style.display = 'none'; }
    async function loadLeaderboard(m) {
        const list = document.getElementById('leaderboard-list'); list.innerHTML = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
        const res = await fetch(`${FB_URL}/leaderboard/${m}.json`);
        const data = await res.json(); list.innerHTML = "";
        if(data) Object.values(data).sort((a,b)=>b.money-a.money).slice(0,10).forEach((u,i)=>list.innerHTML += `<div class="list-row"><span>${i+1}. ${u.name}</span><b>‚Ç¥${Math.floor(u.money)}</b></div>`);
    }

    async function openAuctionHouse() {
        document.getElementById('auction-window').style.display = 'flex';
        const list = document.getElementById('auction-list');
        list.innerHTML = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
        const res = await fetch(`${FB_URL}/auctions.json`);
        const data = await res.json(); list.innerHTML = "";
        if(data) Object.keys(data).forEach(id => {
            const a = data[id];
            list.innerHTML += `<div class="list-row">
                <div style="flex:1"><b>${a.coin.n}–∫ ${a.coin.y}</b><br><small>‚Ç¥${a.currentBid}</small></div>
                <button class="nav-btn btn-gold" style="width:80px" onclick="bidOnAuction('${id}')">–°–¢–ê–í–ö–ê</button>
            </div>`;
        });
    }
    function closeAuctionHouse() { document.getElementById('auction-window').style.display = 'none'; }

    async function startAuction(i) {
        const c = myCoins[i]; const p = prompt("–°—Ç–∞—Ä—Ç–æ–≤–∞ —Ü—ñ–Ω–∞:", c.price); if (!p) return;
        const name = localStorage.getItem('playerName');
        await fetch(`${FB_URL}/auctions/${Date.now()}_${name}.json`, { method:'PUT', body: JSON.stringify({ seller: name, coin: c, currentBid: Number(p), endTime: Date.now() + 172800000 }) });
        myCoins.splice(i, 1); toggleAlbum(); updateUI(); saveProgress();
    }
    async function bidOnAuction(id) {
        const res = await fetch(`${FB_URL}/auctions/${id}.json`); const a = await res.json();
        const next = Math.floor(a.currentBid * 1.1); if (money < next) return alert("–ú–∞–ª–æ –≥—Ä–æ—à–µ–π!");
        await fetch(`${FB_URL}/auctions/${id}.json`, { method:'PATCH', body: JSON.stringify({ currentBid: next, highestBidder: localStorage.getItem('playerName') }) });
        money -= next; updateUI(); saveProgress(); openAuctionHouse();
    }

    function work() { if(xp >= 8) { xp -= 8; money += config.w; updateUI(); saveProgress(); syncOnline(); } }
    function keepFound() { myCoins.push(currentCoin); xp += 10; closeModal(); }
    function sellFound() { money += currentCoin.price; closeModal(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; updateUI(); saveProgress(); syncOnline(); }
    function sellFromAlbum(i) { money += myCoins[i].price; myCoins.splice(i, 1); toggleAlbum(); updateUI(); saveProgress(); }
    function saveProgress() { if(currentModeId) localStorage.setItem('numizmat_' + currentModeId, JSON.stringify({ m: money, x: xp, a: myCoins })); }
    async function syncOnline() {
        const n = localStorage.getItem('playerName');
        if (n && currentModeId) await fetch(`${FB_URL}/leaderboard/${currentModeId}/${n}.json`, { method:'PATCH', body: JSON.stringify({ name:n, money, xp }) });
    }
    async function checkLogin() {
        let name = localStorage.getItem('playerName');
        if (!name) { name = prompt("–ù—ñ–∫–Ω–µ–π–º:"); if (!name) return checkLogin(); localStorage.setItem('playerName', name); }
        document.getElementById('player-display').innerText = "–ì—Ä–∞–≤–µ—Ü—å: " + name;
        update3D("–ù–£–ú–Ü–ó–ú–ê–¢", 2026, false, 0);
    }
    function changeNickname() { localStorage.clear(); location.reload(); }
    function animate() { requestAnimationFrame(animate); pivot.rotation.y += 0.01; renderer.render(scene, camera); }
    animate(); window.onload = checkLogin;
</script>
</body>
</html>
